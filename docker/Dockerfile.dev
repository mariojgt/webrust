FROM rust:bookworm

WORKDIR /app

# Install system dependencies and mold
RUN apt-get update --allow-insecure-repositories && \
    apt-get install -y --allow-unauthenticated \
    pkg-config \
    libssl-dev \
    default-libmysqlclient-dev \
    mold \
    clang \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reloading
RUN cargo install cargo-watch

# Configure cargo to use mold and dynamic linking for faster builds
ENV RUSTFLAGS="-C link-arg=-fuse-ld=mold -C prefer-dynamic"

# Expose the port
EXPOSE 8000

# Default command (can be overridden in docker-compose)
# Watch src and templates, low delay
CMD ["cargo", "watch", "-w", "src", "-w", "templates", "-d", "0.1", "-x", "run -- rune serve --host 0.0.0.0"]
